---
layout: default
title: "Admin Panel"
permalink: /admin/
---

<section class="page-header">
    <div class="container">
        <h1><i class="fas fa-cog"></i> Admin Panel</h1>
        <p>Manage users, materials, and assignments</p>
    </div>
</section>

<div class="admin-required-page" style="display: none;">
    <section class="admin-dashboard">
        <div class="container">
            <div class="dashboard-tabs">
                <button class="tab-button active" data-tab="users">
                    <i class="fas fa-users"></i>
                    Users
                </button>
                <button class="tab-button" data-tab="materials">
                    <i class="fas fa-folder-plus"></i>
                    Materials
                </button>
                <button class="tab-button" data-tab="assignments">
                    <i class="fas fa-plus-square"></i>
                    Assignments
                </button>
                <button class="tab-button" data-tab="submissions">
                    <i class="fas fa-inbox"></i>
                    Submissions
                </button>
                <button class="tab-button" data-tab="messages">
                    <i class="fas fa-envelope"></i>
                    Messages
                </button>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content active">
                <div class="section-header">
                    <h2>User Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="exportUsers()">
                            <i class="fas fa-download"></i>
                            Export Users
                        </button>
                    </div>
                </div>

                <div class="admin-stats">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <div class="stat-info">
                            <span class="stat-number" id="total-users">0</span>
                            <span class="stat-label">Total Users</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-check"></i>
                        <div class="stat-info">
                            <span class="stat-number" id="approved-users">0</span>
                            <span class="stat-label">Approved Users</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-clock"></i>
                        <div class="stat-info">
                            <span class="stat-number" id="pending-users">0</span>
                            <span class="stat-label">Pending Approval</span>
                        </div>
                    </div>
                </div>

                <div class="users-table-container">
                    <table class="admin-table" id="users-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="6" class="loading-cell">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Materials Tab -->
            <div id="materials-tab" class="tab-content">
                <div class="section-header">
                    <h2>Training Materials</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="addMaterial()">
                            <i class="fas fa-plus"></i>
                            Add Material
                        </button>
                    </div>
                </div>

                <div class="materials-list" id="admin-materials-list">
                    <div class="loading-placeholder">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading materials...</p>
                    </div>
                </div>
            </div>

            <!-- Assignments Tab -->
            <div id="assignments-tab" class="tab-content">
                <div class="section-header">
                    <h2>Assignments</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="addAssignment()">
                            <i class="fas fa-plus"></i>
                            Create Assignment
                        </button>
                    </div>
                </div>

                <div class="assignments-list" id="admin-assignments-list">
                    <div class="loading-placeholder">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading assignments...</p>
                    </div>
                </div>
            </div>

            <!-- Submissions Tab -->
            <div id="submissions-tab" class="tab-content">
                <div class="section-header">
                    <h2>Assignment Submissions</h2>
                    <div class="section-actions">
                        <select id="submission-filter" onchange="filterSubmissions()">
                            <option value="all">All Submissions</option>
                            <option value="submitted">Submitted</option>
                            <option value="graded">Graded</option>
                            <option value="pending">Pending Review</option>
                        </select>
                    </div>
                </div>

                <div class="submissions-list" id="submissions-list">
                    <div class="loading-placeholder">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading submissions...</p>
                    </div>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messages-tab" class="tab-content">
                <div class="section-header">
                    <h2>Contact Messages</h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary" onclick="markAllRead()">
                            <i class="fas fa-check-double"></i>
                            Mark All Read
                        </button>
                    </div>
                </div>

                <div class="messages-list" id="messages-list">
                    <div class="loading-placeholder">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading messages...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Not authorized message -->
<div class="admin-required-message">
    <div class="container">
        <div class="message-card">
            <i class="fas fa-shield-alt fa-3x"></i>
            <h2>Admin Access Required</h2>
            <p>You need administrator privileges to access this page.</p>
            <a href="/" class="btn btn-primary">
                <i class="fas fa-home"></i>
                Return to Home
            </a>
        </div>
    </div>
</div>

<!-- Material Modal -->
<div id="material-modal" class="modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h2 id="material-modal-title">Add Training Material</h2>
            <span class="modal-close">&times;</span>
        </div>
        <form id="material-form">
            <div class="modal-body">
                <input type="hidden" id="material-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="material-title">Title *</label>
                        <input type="text" id="material-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="material-type">Type *</label>
                        <select id="material-type" name="type" required>
                            <option value="">Select type...</option>
                            <option value="pdf">PDF Document</option>
                            <option value="video">Video</option>
                            <option value="presentation">Presentation</option>
                            <option value="document">Document</option>
                            <option value="archive">Archive/Zip</option>
                            <option value="link">External Link</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="material-description">Description</label>
                    <textarea id="material-description" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="material-file">File Upload</label>
                    <input type="file" id="material-file" name="file">
                    <small>Or use external link below</small>
                </div>
                
                <div class="form-group">
                    <label for="material-url">External URL</label>
                    <input type="url" id="material-url" name="url" placeholder="https://...">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="material-published" name="published">
                            Published (visible to students)
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="material-featured" name="featured">
                            Featured
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Material</button>
            </div>
        </form>
    </div>
</div>

<!-- Assignment Modal -->
<div id="assignment-modal" class="modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h2 id="assignment-modal-title">Create Assignment</h2>
            <span class="modal-close">&times;</span>
        </div>
        <form id="assignment-form">
            <div class="modal-body">
                <input type="hidden" id="assignment-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="assignment-title">Title *</label>
                        <input type="text" id="assignment-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="assignment-difficulty">Difficulty *</label>
                        <select id="assignment-difficulty" name="difficulty" required>
                            <option value="">Select difficulty...</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="assignment-description">Description *</label>
                    <textarea id="assignment-description" name="description" rows="4" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="assignment-instructions">Instructions</label>
                    <textarea id="assignment-instructions" name="instructions" rows="6" placeholder="Detailed instructions for students..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="assignment-due-date">Due Date *</label>
                        <input type="datetime-local" id="assignment-due-date" name="dueDate" required>
                    </div>
                    <div class="form-group">
                        <label for="assignment-estimated-time">Estimated Time (hours)</label>
                        <input type="number" id="assignment-estimated-time" name="estimatedTime" min="0.5" step="0.5">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="assignment-published" name="published">
                        Published (visible to students)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Assignment</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Check admin access
    function checkAdminAccess() {
        if (window.authManager && window.authManager.isAdmin()) {
            document.querySelector('.admin-required-page').style.display = 'block';
            document.querySelector('.admin-required-message').style.display = 'none';
            loadAdminData();
        } else {
            document.querySelector('.admin-required-page').style.display = 'none';
            document.querySelector('.admin-required-message').style.display = 'block';
        }
    }

    // Tab functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab');
            
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            button.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Load specific tab data
            switch(tabName) {
                case 'users':
                    loadUsers();
                    break;
                case 'materials':
                    loadAdminMaterials();
                    break;
                case 'assignments':
                    loadAdminAssignments();
                    break;
                case 'submissions':
                    loadSubmissions();
                    break;
                case 'messages':
                    loadMessages();
                    break;
            }
        });
    });

    async function loadAdminData() {
        loadUsers();
    }

    async function loadUsers() {
        const tableBody = document.getElementById('users-table-body');
        
        try {
            const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
            const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Update stats
            document.getElementById('total-users').textContent = users.length;
            document.getElementById('approved-users').textContent = users.filter(u => u.approved).length;
            document.getElementById('pending-users').textContent = users.filter(u => !u.approved && u.role !== 'admin').length;

            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="empty-cell">No users found</td></tr>';
                return;
            }

            tableBody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div class="user-info">
                            <img src="${user.photoURL || '/assets/images/default-avatar.png'}" alt="Avatar" class="user-avatar-small">
                            <span>${user.displayName || 'No name'}</span>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <select onchange="updateUserRole('${user.id}', this.value)" class="role-select">
                            <option value="student" ${user.role === 'student' ? 'selected' : ''}>Student</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                    <td>
                        <span class="status-badge ${user.approved ? 'approved' : 'pending'}">
                            ${user.approved ? 'Approved' : 'Pending'}
                        </span>
                    </td>
                    <td>${formatDate(user.lastLogin)}</td>
                    <td>
                        <div class="action-buttons">
                            ${!user.approved ? `<button class="btn btn-sm btn-success" onclick="approveUser('${user.id}')">Approve</button>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');

        } catch (error) {
            console.error('Error loading users:', error);
            tableBody.innerHTML = '<tr><td colspan="6" class="error-cell">Error loading users</td></tr>';
        }
    }

    // Global functions for admin actions
    window.updateUserRole = async (userId, newRole) => {
        try {
            await db.collection('users').doc(userId).update({ role: newRole });
            window.authManager.showMessage('User role updated successfully', 'success');
        } catch (error) {
            console.error('Error updating user role:', error);
            window.authManager.showMessage('Error updating user role', 'error');
        }
    };

    window.approveUser = async (userId) => {
        try {
            await db.collection('users').doc(userId).update({ approved: true });
            window.authManager.showMessage('User approved successfully', 'success');
            loadUsers(); // Reload the table
        } catch (error) {
            console.error('Error approving user:', error);
            window.authManager.showMessage('Error approving user', 'error');
        }
    };

    window.deleteUser = async (userId) => {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            return;
        }

        try {
            await db.collection('users').doc(userId).delete();
            window.authManager.showMessage('User deleted successfully', 'success');
            loadUsers(); // Reload the table
        } catch (error) {
            console.error('Error deleting user:', error);
            window.authManager.showMessage('Error deleting user', 'error');
        }
    };

    window.addMaterial = () => {
        document.getElementById('material-modal-title').textContent = 'Add Training Material';
        document.getElementById('material-form').reset();
        document.getElementById('material-id').value = '';
        document.getElementById('material-modal').style.display = 'block';
    };

    window.addAssignment = () => {
        document.getElementById('assignment-modal-title').textContent = 'Create Assignment';
        document.getElementById('assignment-form').reset();
        document.getElementById('assignment-id').value = '';
        document.getElementById('assignment-modal').style.display = 'block';
    };

    // Modal handling
    document.querySelectorAll('.modal').forEach(modal => {
        const closeBtn = modal.querySelector('.modal-close');
        const cancelBtn = modal.querySelector('.modal-cancel');

        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
    });

    // Form submissions
    document.getElementById('material-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        // Implementation for saving materials
        console.log('Saving material...');
    });

    document.getElementById('assignment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        // Implementation for saving assignments
        console.log('Saving assignment...');
    });

    function formatDate(timestamp) {
        if (!timestamp) return 'Never';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    // Check admin access on page load and auth state changes
    checkAdminAccess();
    
    if (window.authManager) {
        auth.onAuthStateChanged(() => {
            setTimeout(checkAdminAccess, 100);
        });
    }
});
</script>